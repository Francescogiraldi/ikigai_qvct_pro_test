<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Intégration Supabase pour IKIGAI</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1, h2 {
            color: #2563eb;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        .error {
            color: #ef4444;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
        }
        .success {
            color: #10b981;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
        }
        .result {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Test d'Intégration Supabase pour IKIGAI</h1>
    
    <div class="card">
        <h2>Connexion</h2>
        <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="Votre email">
        </div>
        <div class="form-group">
            <label for="loginPassword">Mot de passe</label>
            <input type="password" id="loginPassword" placeholder="Votre mot de passe">
        </div>
        <button id="loginButton">Se connecter</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="card">
        <h2>Inscription</h2>
        <div class="form-group">
            <label for="signupEmail">Email</label>
            <input type="email" id="signupEmail" placeholder="Votre email">
        </div>
        <div class="form-group">
            <label for="signupPassword">Mot de passe</label>
            <input type="password" id="signupPassword" placeholder="Votre mot de passe">
        </div>
        <button id="signupButton">S'inscrire</button>
        <div id="signupResult"></div>
    </div>
    
    <div class="card">
        <h2>Vérification de la session</h2>
        <button id="sessionButton">Vérifier la session</button>
        <div id="sessionResult"></div>
    </div>
    
    <div class="card">
        <h2>Déconnexion</h2>
        <button id="logoutButton">Se déconnecter</button>
        <div id="logoutResult"></div>
    </div>

    <div class="card">
        <h2>Tester les tables Supabase</h2>
        <button id="testTablesButton">Tester les tables</button>
        <div id="testTablesResult"></div>
    </div>

    <!-- Chargement de la librairie Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
    
    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://mgegwthaogszzgflwery.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nZWd3dGhhb2dzenpnZmx3ZXJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxMjUyMjIsImV4cCI6MjA1OTcwMTIyMn0.ojqRmmC1O4sFTJDydtdSQ15J5ywMyCNBAkMYAkqYQxM';
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // Fonction pour gérer les erreurs
        function handleSupabaseError(error) {
            // Si l'erreur est un objet vide, retourner un message explicite
            if (error && typeof error === 'object' && Object.keys(error).length === 0) {
                return "Le service d'authentification est temporairement indisponible. Veuillez réessayer plus tard.";
            }
            
            // Si l'erreur a un message, l'utiliser
            if (error && error.message) {
                return error.message;
            }
            
            // Si l'erreur est une chaîne, l'utiliser directement
            if (typeof error === 'string') {
                return error;
            }
            
            // Message par défaut
            return "Une erreur s'est produite. Veuillez réessayer.";
        }
        
        // Fonction pour afficher les résultats
        function displayResult(elementId, success, message, data = null) {
            const resultElement = document.getElementById(elementId);
            resultElement.className = success ? 'success' : 'error';
            
            let resultHTML = message;
            
            if (data) {
                resultHTML += '<div class="result">' + JSON.stringify(data, null, 2) + '</div>';
            }
            
            resultElement.innerHTML = resultHTML;
        }
        
        // Gérer la connexion
        document.getElementById('loginButton').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                displayResult('loginResult', false, 'Veuillez remplir tous les champs.');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    const errorMessage = handleSupabaseError(error);
                    displayResult('loginResult', false, `Erreur lors de la connexion: ${errorMessage}`, error);
                    
                    // Vérifier si l'erreur est un objet vide
                    if (typeof error === 'object' && Object.keys(error).length === 0) {
                        console.error("Objet d'erreur vide détecté:", error);
                    }
                } else {
                    displayResult('loginResult', true, 'Connexion réussie !', data);
                }
            } catch (error) {
                displayResult('loginResult', false, `Exception: ${error.message || error}`, error);
            }
        });
        
        // Gérer l'inscription
        document.getElementById('signupButton').addEventListener('click', async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!email || !password) {
                displayResult('signupResult', false, 'Veuillez remplir tous les champs.');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: 'Test',
                            last_name: 'Utilisateur',
                            status: 'Test'
                        }
                    }
                });
                
                if (error) {
                    const errorMessage = handleSupabaseError(error);
                    displayResult('signupResult', false, `Erreur lors de l'inscription: ${errorMessage}`, error);
                    
                    // Vérifier si l'erreur est un objet vide
                    if (typeof error === 'object' && Object.keys(error).length === 0) {
                        console.error("Objet d'erreur vide détecté:", error);
                    }
                } else {
                    displayResult('signupResult', true, 'Inscription réussie ! Vérifiez votre email pour confirmer votre compte.', data);
                }
            } catch (error) {
                displayResult('signupResult', false, `Exception: ${error.message || error}`, error);
            }
        });
        
        // Gérer la vérification de session
        document.getElementById('sessionButton').addEventListener('click', async () => {
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    const errorMessage = handleSupabaseError(error);
                    displayResult('sessionResult', false, `Erreur lors de la vérification de session: ${errorMessage}`, error);
                } else if (data && data.session) {
                    displayResult('sessionResult', true, 'Session active trouvée !', data);
                } else {
                    displayResult('sessionResult', false, 'Aucune session active.', data);
                }
            } catch (error) {
                displayResult('sessionResult', false, `Exception: ${error.message || error}`, error);
            }
        });
        
        // Gérer la déconnexion
        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    const errorMessage = handleSupabaseError(error);
                    displayResult('logoutResult', false, `Erreur lors de la déconnexion: ${errorMessage}`, error);
                } else {
                    displayResult('logoutResult', true, 'Déconnexion réussie !');
                }
            } catch (error) {
                displayResult('logoutResult', false, `Exception: ${error.message || error}`, error);
            }
        });
        
        // Tester les tables Supabase
        document.getElementById('testTablesButton').addEventListener('click', async () => {
            try {
                const resultDiv = document.getElementById('testTablesResult');
                resultDiv.innerHTML = '<p>Test des tables en cours...</p>';
                
                // 1. Vérifier si la table user_progress existe
                let results = '<h3>Résultats des tests:</h3><ul>';
                
                try {
                    const { data: progressData, error: progressError } = await supabase
                        .from('user_progress')
                        .select('id')
                        .limit(1);
                    
                    if (progressError) {
                        results += `<li style="color: red;">❌ Table user_progress: ${progressError.message}</li>`;
                    } else {
                        results += '<li style="color: green;">✅ Table user_progress existe</li>';
                    }
                } catch (e) {
                    results += `<li style="color: red;">❌ Erreur lors du test de user_progress: ${e.message}</li>`;
                }
                
                // 2. Vérifier si la table onboarding_responses existe
                try {
                    const { data: onboardingData, error: onboardingError } = await supabase
                        .from('onboarding_responses')
                        .select('id')
                        .limit(1);
                    
                    if (onboardingError) {
                        results += `<li style="color: red;">❌ Table onboarding_responses: ${onboardingError.message}</li>`;
                    } else {
                        results += '<li style="color: green;">✅ Table onboarding_responses existe</li>';
                    }
                } catch (e) {
                    results += `<li style="color: red;">❌ Erreur lors du test de onboarding_responses: ${e.message}</li>`;
                }
                
                // 3. Vérifier si la table user_responses existe
                try {
                    const { data: userResponsesData, error: userResponsesError } = await supabase
                        .from('user_responses')
                        .select('id')
                        .limit(1);
                    
                    if (userResponsesError) {
                        results += `<li style="color: red;">❌ Table user_responses: ${userResponsesError.message}</li>`;
                    } else {
                        results += '<li style="color: green;">✅ Table user_responses existe</li>';
                    }
                } catch (e) {
                    results += `<li style="color: red;">❌ Erreur lors du test de user_responses: ${e.message}</li>`;
                }
                
                results += '</ul>';
                
                // Afficher le résultat complet
                resultDiv.innerHTML = results;
                
            } catch (error) {
                displayResult('testTablesResult', false, `Exception générale: ${error.message || error}`, error);
            }
        });
    </script>
</body>
</html>