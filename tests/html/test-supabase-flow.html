<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Flux Supabase pour IKIGAI</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1, h2, h3 {
            color: #2563eb;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, button, select, textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 100%;
            font-size: 16px;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        .error {
            color: #ef4444;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
        }
        .success {
            color: #10b981;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
        }
        .result {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
            background-color: #f8fafc;
        }
        .step h3 {
            margin-top: 0;
        }
        .step-success {
            border-left-color: #10b981;
        }
        .step-error {
            border-left-color: #ef4444;
        }
        .step-pending {
            border-left-color: #f59e0b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #e5e7eb;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f1f5f9;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .actions button {
            flex: 1;
        }
        .section-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            background-color: #f1f5f9;
            margin-bottom: 10px;
        }
        .section-toggle:hover {
            background-color: #e0e7ff;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Test de Flux Supabase pour IKIGAI</h1>
    <p>Cette page permet de tester l'int√©gration compl√®te avec Supabase en simulant le flux d'un nouvel utilisateur.</p>
    
    <div class="card">
        <h2>Configuration</h2>
        <div class="form-group">
            <label for="testEmail">Email de test (g√©n√©r√© automatiquement)</label>
            <input type="email" id="testEmail" readonly>
        </div>
        <div class="form-group">
            <label for="testPassword">Mot de passe de test</label>
            <input type="text" id="testPassword" value="Test@123456" readonly>
        </div>
        <div class="form-group">
            <label for="cleanupData">Nettoyer les donn√©es apr√®s le test</label>
            <select id="cleanupData">
                <option value="no">Non (garder les donn√©es pour inspection)</option>
                <option value="yes">Oui (supprimer les donn√©es de test)</option>
            </select>
        </div>
        <button id="startTestButton">D√©marrer le test complet</button>
        <button id="stepByStepButton" style="background-color: #4f46e5;">Mode pas √† pas</button>
    </div>
    
    <div class="card">
        <div class="section-toggle" id="logToggle">
            <h2>Journal des op√©rations</h2>
            <span>‚ñº</span>
        </div>
        <div id="logSection">
            <div id="logOutput" class="result">Aucune op√©ration effectu√©e</div>
        </div>
    </div>
    
    <div id="stepByStepContainer" class="hidden">
        <div class="card">
            <h2>Test par √©tapes</h2>
            <p>Ex√©cutez chaque √©tape individuellement pour mieux comprendre le flux de donn√©es.</p>
            
            <div id="step1" class="step">
                <h3>1. Inscription d'un nouvel utilisateur</h3>
                <p>Cr√©e un nouvel utilisateur dans Supabase Auth avec l'email et le mot de passe g√©n√©r√©s.</p>
                <div class="actions">
                    <button data-step="1">Ex√©cuter</button>
                </div>
                <div id="step1-result"></div>
            </div>
            
            <div id="step2" class="step">
                <h3>2. Connexion utilisateur</h3>
                <p>Se connecte avec les identifiants du nouvel utilisateur pour √©tablir une session.</p>
                <div class="actions">
                    <button data-step="2">Ex√©cuter</button>
                </div>
                <div id="step2-result"></div>
            </div>
            
            <div id="step3" class="step">
                <h3>3. Enregistrement des donn√©es d'onboarding</h3>
                <p>Simule la compl√©tion du processus d'onboarding et sauvegarde les r√©ponses.</p>
                <div class="actions">
                    <button data-step="3">Ex√©cuter</button>
                </div>
                <div id="step3-result"></div>
            </div>
            
            <div id="step4" class="step">
                <h3>4. V√©rification des donn√©es d'onboarding</h3>
                <p>V√©rifie que les donn√©es d'onboarding ont √©t√© correctement enregistr√©es dans Supabase.</p>
                <div class="actions">
                    <button data-step="4">Ex√©cuter</button>
                </div>
                <div id="step4-result"></div>
            </div>
            
            <div id="step5" class="step">
                <h3>5. Cr√©ation de progression utilisateur</h3>
                <p>Cr√©e et sauvegarde des donn√©es de progression pour l'utilisateur (points, modules, etc.).</p>
                <div class="actions">
                    <button data-step="5">Ex√©cuter</button>
                </div>
                <div id="step5-result"></div>
            </div>
            
            <div id="step6" class="step">
                <h3>6. V√©rification des donn√©es de progression</h3>
                <p>V√©rifie que les donn√©es de progression ont √©t√© correctement enregistr√©es.</p>
                <div class="actions">
                    <button data-step="6">Ex√©cuter</button>
                </div>
                <div id="step6-result"></div>
            </div>
            
            <div id="step7" class="step">
                <h3>7. Enregistrement de r√©ponses de module</h3>
                <p>Simule la compl√©tion d'un module et l'enregistrement des r√©ponses associ√©es.</p>
                <div class="actions">
                    <button data-step="7">Ex√©cuter</button>
                </div>
                <div id="step7-result"></div>
            </div>
            
            <div id="step8" class="step">
                <h3>8. V√©rification des r√©ponses de module</h3>
                <p>V√©rifie que les r√©ponses du module ont √©t√© correctement enregistr√©es.</p>
                <div class="actions">
                    <button data-step="8">Ex√©cuter</button>
                </div>
                <div id="step8-result"></div>
            </div>
            
            <div id="step9" class="step">
                <h3>9. D√©connexion</h3>
                <p>Termine la session utilisateur.</p>
                <div class="actions">
                    <button data-step="9">Ex√©cuter</button>
                </div>
                <div id="step9-result"></div>
            </div>
            
            <div id="stepCleanup" class="step">
                <h3>10. Nettoyage des donn√©es (optionnel)</h3>
                <p>Supprime toutes les donn√©es de test cr√©√©es pendant le processus.</p>
                <div class="actions">
                    <button data-step="cleanup">Ex√©cuter</button>
                </div>
                <div id="stepCleanup-result"></div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="section-toggle" id="resultsToggle">
            <h2>R√©sultats des tests</h2>
            <span>‚ñº</span>
        </div>
        <div id="resultsSection">
            <div id="testResults" class="result">
                <p>Les r√©sultats des tests s'afficheront ici apr√®s ex√©cution.</p>
            </div>
            
            <h3>R√©sum√© des tables Supabase</h3>
            <table id="databaseSummary">
                <thead>
                    <tr>
                        <th>Table</th>
                        <th>Enregistrements</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>auth.users</td>
                        <td id="users-count">-</td>
                        <td id="users-status">Non test√©</td>
                    </tr>
                    <tr>
                        <td>user_progress</td>
                        <td id="progress-count">-</td>
                        <td id="progress-status">Non test√©</td>
                    </tr>
                    <tr>
                        <td>onboarding_responses</td>
                        <td id="onboarding-count">-</td>
                        <td id="onboarding-status">Non test√©</td>
                    </tr>
                    <tr>
                        <td>user_responses</td>
                        <td id="responses-count">-</td>
                        <td id="responses-status">Non test√©</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chargement des librairies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
    <script src="../config.js"></script>
    
    <script>
        // Configuration Supabase depuis le fichier de configuration centralis√©
        const { supabaseUrl, supabaseAnonKey } = getTestConfig();
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // V√©rifier si les cl√©s sont d√©finies
        if (!supabaseUrl || !supabaseAnonKey) {
            alert('ATTENTION: Variables d\'environnement Supabase non d√©finies. Veuillez configurer votre fichier .env');
        }
        
        // √âtat global du test
        const testState = {
            userId: null,
            email: null,
            password: 'Test@123456',
            step: 0,
            cleanup: false,
            results: {}
        };
        
        // Fonction pour ajouter des entr√©es au journal
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // Fonction pour afficher le r√©sultat d'une √©tape
        function showStepResult(step, success, message, data = null) {
            const resultElement = document.getElementById(`step${step}-result`);
            const stepElement = document.getElementById(`step${step}`);
            
            stepElement.className = success ? 'step step-success' : 'step step-error';
            
            let resultHTML = `<div class="${success ? 'success' : 'error'}">${message}</div>`;
            
            if (data) {
                resultHTML += `<div class="result">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</div>`;
            }
            
            resultElement.innerHTML = resultHTML;
        }
        
        // Fonction pour mettre √† jour le r√©sum√© des tables
        async function updateDatabaseSummary(userId) {
            if (!userId) return;
            
            try {
                // V√©rifier l'utilisateur
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                document.getElementById('users-count').textContent = user ? '1' : '0';
                document.getElementById('users-status').textContent = user ? 'OK' : 'Non trouv√©';
                
                // V√©rifier user_progress
                const { data: progressData, error: progressError } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', userId);
                    
                document.getElementById('progress-count').textContent = progressData?.length || '0';
                document.getElementById('progress-status').textContent = 
                    progressError ? 'Erreur' : (progressData?.length ? 'OK' : 'Vide');
                
                // V√©rifier onboarding_responses
                const { data: onboardingData, error: onboardingError } = await supabase
                    .from('onboarding_responses')
                    .select('*')
                    .eq('user_id', userId);
                    
                document.getElementById('onboarding-count').textContent = onboardingData?.length || '0';
                document.getElementById('onboarding-status').textContent = 
                    onboardingError ? (onboardingError.code === 'PGRST116' ? 'Table inexistante' : 'Erreur') : 
                    (onboardingData?.length ? 'OK' : 'Vide');
                
                // V√©rifier user_responses
                const { data: responsesData, error: responsesError } = await supabase
                    .from('user_responses')
                    .select('*')
                    .eq('user_id', userId);
                    
                document.getElementById('responses-count').textContent = responsesData?.length || '0';
                document.getElementById('responses-status').textContent = 
                    responsesError ? (responsesError.code === 'PGRST116' ? 'Table inexistante' : 'Erreur') : 
                    (responsesData?.length ? 'OK' : 'Vide');
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du r√©sum√©:', error);
            }
        }
        
        // Fonctions pour les √©tapes individuelles
        async function step1_signup() {
            try {
                log('√âtape 1: Inscription d\'un nouvel utilisateur');
                
                // G√©n√©rer un email unique pour le test
                testState.email = `test_${Date.now()}@example.com`;
                document.getElementById('testEmail').value = testState.email;
                
                // Inscrire l'utilisateur
                const { data, error } = await supabase.auth.signUp({
                    email: testState.email,
                    password: testState.password,
                    options: {
                        data: {
                            first_name: 'Test',
                            last_name: 'Utilisateur',
                            status: 'Test'
                        }
                    }
                });
                
                if (error) throw error;
                
                testState.userId = data.user.id;
                log(`Utilisateur cr√©√© avec succ√®s: ${testState.userId}`, 'success');
                
                showStepResult(1, true, 'Inscription r√©ussie!', {
                    userId: testState.userId,
                    email: testState.email
                });
                
                testState.results.signup = {
                    success: true,
                    userId: testState.userId,
                    email: testState.email
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de l'inscription: ${error.message}`, 'error');
                showStepResult(1, false, `Erreur lors de l'inscription: ${error.message}`, error);
                
                testState.results.signup = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step2_signin() {
            try {
                log('√âtape 2: Connexion avec le nouvel utilisateur');
                
                // Se connecter avec l'utilisateur cr√©√©
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: testState.email,
                    password: testState.password
                });
                
                if (error) throw error;
                
                log(`Connexion r√©ussie pour ${testState.email}`, 'success');
                showStepResult(2, true, 'Connexion r√©ussie!', {
                    userId: data.user.id,
                    session: !!data.session
                });
                
                testState.results.signin = {
                    success: true,
                    userId: data.user.id
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de la connexion: ${error.message}`, 'error');
                showStepResult(2, false, `Erreur lors de la connexion: ${error.message}`, error);
                
                testState.results.signin = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step3_saveOnboarding() {
            try {
                log('√âtape 3: Enregistrement des donn√©es d\'onboarding');
                
                // Cr√©er les r√©ponses d'onboarding
                const onboardingResponses = {
                    q1: 'Stress et anxi√©t√©',
                    q2: ['M√©ditation', 'Respiration'],
                    q3: 7,
                    q4: 'Mieux dormir',
                    q5_custom: {
                        'Autre objectif': 'Am√©liorer ma concentration'
                    },
                    completedAt: new Date().toISOString()
                };
                
                // V√©rifier si l'utilisateur est connect√©
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Aucun utilisateur connect√©');
                }
                
                // Sauvegarder dans la table onboarding_responses
                try {
                    const { error } = await supabase
                        .from('onboarding_responses')
                        .upsert({
                            user_id: user.id,
                            responses: onboardingResponses,
                            updated_at: new Date()
                        });
                        
                    if (error) {
                        if (error.code === 'PGRST116' || error.message.includes("relation") || error.message.includes("does not exist")) {
                            log('Table onboarding_responses non disponible, tentative avec user_responses', 'warning');
                            throw new Error('table_not_found');
                        }
                        throw error;
                    }
                    
                    log('Donn√©es d\'onboarding enregistr√©es avec succ√®s (table d√©di√©e)', 'success');
                } catch (err) {
                    // Si la table sp√©cifique n'existe pas, tenter la table g√©n√©rique
                    if (err.message === 'table_not_found') {
                        const { error: userResponsesError } = await supabase
                            .from('user_responses')
                            .upsert({
                                user_id: user.id,
                                module_id: 'onboarding',
                                responses: onboardingResponses,
                                created_at: new Date()
                            });
                            
                        if (userResponsesError) {
                            throw userResponsesError;
                        }
                        
                        log('Donn√©es d\'onboarding enregistr√©es avec succ√®s (table user_responses)', 'success');
                    } else {
                        throw err;
                    }
                }
                
                // Mise √† jour de user_progress pour compatibilit√©
                try {
                    // D'abord v√©rifier si une entr√©e existe
                    const { data: existingProgress } = await supabase
                        .from('user_progress')
                        .select('*')
                        .eq('user_id', user.id)
                        .single();
                    
                    // Structure de base pour les donn√©es de progression
                    let progress_data = {
                        userId: user.id,
                        totalPoints: 0,
                        streak: 0,
                        wellnessScore: 65,
                        completedModules: {},
                        completedChallenges: [],
                        badges: [],
                        moduleResponses: {
                            onboarding: {
                                responses: onboardingResponses,
                                completedAt: new Date().toISOString()
                            }
                        },
                        islandProgress: {
                            mindfulness: { progress: 0, completedModules: 0 },
                            productivity: { progress: 0, completedModules: 0 },
                            stress: { progress: 0, completedModules: 0 },
                            balance: { progress: 0, completedModules: 0 }
                        }
                    };
                    
                    // Si des donn√©es existent d√©j√†, les fusionner
                    if (existingProgress) {
                        try {
                            const existingData = typeof existingProgress.progress_data === 'string' 
                                ? JSON.parse(existingProgress.progress_data) 
                                : existingProgress.progress_data;
                                
                            // Fusionner avec les donn√©es existantes, en gardant les nouvelles r√©ponses d'onboarding
                            progress_data = {
                                ...existingData,
                                moduleResponses: {
                                    ...existingData.moduleResponses,
                                    onboarding: {
                                        responses: onboardingResponses,
                                        completedAt: new Date().toISOString()
                                    }
                                }
                            };
                        } catch (e) {
                            console.warn('Erreur lors du parsing des donn√©es existantes:', e);
                        }
                    }
                    
                    // Sauvegarder dans user_progress
                    const { error: progressError } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: user.id,
                            progress_data: JSON.stringify(progress_data),
                            updated_at: new Date()
                        });
                        
                    if (progressError) {
                        throw progressError;
                    }
                    
                    log('Progression utilisateur mise √† jour avec les donn√©es d\'onboarding', 'success');
                } catch (progressErr) {
                    log(`Avertissement: Impossible de mettre √† jour user_progress: ${progressErr.message}`, 'warning');
                }
                
                showStepResult(3, true, 'Donn√©es d\'onboarding enregistr√©es avec succ√®s', onboardingResponses);
                
                testState.results.onboarding = {
                    success: true,
                    responses: onboardingResponses
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de l'enregistrement des donn√©es d'onboarding: ${error.message}`, 'error');
                showStepResult(3, false, `Erreur: ${error.message}`, error);
                
                testState.results.onboarding = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step4_verifyOnboarding() {
            try {
                log('√âtape 4: V√©rification des donn√©es d\'onboarding');
                
                let onboardingData = null;
                let onboardingSource = "";
                
                // V√©rifier dans la table d√©di√©e onboarding_responses
                try {
                    const { data: dedicatedData, error: dedicatedError } = await supabase
                        .from('onboarding_responses')
                        .select('*')
                        .eq('user_id', testState.userId)
                        .single();
                        
                    if (dedicatedData) {
                        onboardingData = dedicatedData;
                        onboardingSource = "Table onboarding_responses";
                        log('Donn√©es trouv√©es dans la table d√©di√©e onboarding_responses', 'success');
                    } else if (dedicatedError && dedicatedError.code !== 'PGRST116') {
                        log(`Erreur lors de la recherche dans onboarding_responses: ${dedicatedError.message}`, 'warning');
                    }
                } catch (err) {
                    log(`Exception lors de la recherche dans onboarding_responses: ${err.message}`, 'warning');
                }
                
                // Si non trouv√©, v√©rifier dans user_responses
                if (!onboardingData) {
                    try {
                        const { data: standardData, error: standardError } = await supabase
                            .from('user_responses')
                            .select('*')
                            .eq('user_id', testState.userId)
                            .eq('module_id', 'onboarding')
                            .single();
                            
                        if (standardData) {
                            onboardingData = standardData;
                            onboardingSource = "Table user_responses";
                            log('Donn√©es trouv√©es dans la table user_responses', 'success');
                        } else if (standardError && standardError.code !== 'PGRST116') {
                            log(`Erreur lors de la recherche dans user_responses: ${standardError.message}`, 'warning');
                        }
                    } catch (err) {
                        log(`Exception lors de la recherche dans user_responses: ${err.message}`, 'warning');
                    }
                }
                
                // Si toujours non trouv√©, v√©rifier dans progress_data
                if (!onboardingData) {
                    try {
                        const { data: progressData, error: progressError } = await supabase
                            .from('user_progress')
                            .select('progress_data')
                            .eq('user_id', testState.userId)
                            .single();
                            
                        if (progressData?.progress_data) {
                            const parsedData = typeof progressData.progress_data === 'string' 
                                ? JSON.parse(progressData.progress_data) 
                                : progressData.progress_data;
                                
                            if (parsedData.moduleResponses?.onboarding) {
                                onboardingData = { 
                                    embedded: true, 
                                    responses: parsedData.moduleResponses.onboarding 
                                };
                                onboardingSource = "Dans progress_data (user_progress)";
                                log('Donn√©es trouv√©es dans le champ progress_data de user_progress', 'success');
                            }
                        }
                    } catch (err) {
                        log(`Exception lors de la recherche dans progress_data: ${err.message}`, 'warning');
                    }
                }
                
                if (onboardingData) {
                    showStepResult(4, true, `Donn√©es trouv√©es dans: ${onboardingSource}`, onboardingData);
                    
                    testState.results.verifyOnboarding = {
                        success: true,
                        source: onboardingSource,
                        data: onboardingData
                    };
                    
                    return true;
                } else {
                    throw new Error('Donn√©es d\'onboarding non trouv√©es dans aucune table');
                }
            } catch (error) {
                log(`Erreur lors de la v√©rification des donn√©es d'onboarding: ${error.message}`, 'error');
                showStepResult(4, false, `Erreur: ${error.message}`, error);
                
                testState.results.verifyOnboarding = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step5_createProgress() {
            try {
                log('√âtape 5: Cr√©ation et sauvegarde de progression utilisateur');
                
                // V√©rifier si l'utilisateur est connect√©
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Aucun utilisateur connect√©');
                }
                
                // Cr√©er des donn√©es de progression
                const progress_data = {
                    userId: user.id,
                    totalPoints: 100,
                    streak: 1,
                    wellnessScore: 70,
                    completedModules: {
                        'mindfulness_1': true
                    },
                    completedChallenges: ['daily_meditation_1'],
                    badges: [{
                        id: 'mindfulness_beginner',
                        name: 'D√©couvreur de mindfulness',
                        description: 'Premier module de l\'√Æle mindfulness compl√©t√©',
                        icon: 'üå±'
                    }],
                    islandProgress: {
                        mindfulness: { progress: 25, completedModules: 1 },
                        productivity: { progress: 0, completedModules: 0 },
                        stress: { progress: 0, completedModules: 0 },
                        balance: { progress: 0, completedModules: 0 }
                    }
                };
                
                // Sauvegarder dans user_progress
                const { error } = await supabase
                    .from('user_progress')
                    .upsert({
                        user_id: user.id,
                        progress_data: JSON.stringify(progress_data),
                        updated_at: new Date()
                    });
                    
                if (error) throw error;
                
                log('Progression utilisateur cr√©√©e et sauvegard√©e avec succ√®s', 'success');
                showStepResult(5, true, 'Progression cr√©√©e avec succ√®s', {
                    points: progress_data.totalPoints,
                    modules: Object.keys(progress_data.completedModules),
                    badges: progress_data.badges.length
                });
                
                testState.results.createProgress = {
                    success: true,
                    progress_data: progress_data
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de la cr√©ation de progression: ${error.message}`, 'error');
                showStepResult(5, false, `Erreur: ${error.message}`, error);
                
                testState.results.createProgress = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step6_verifyProgress() {
            try {
                log('√âtape 6: V√©rification des donn√©es de progression');
                
                // R√©cup√©rer les donn√©es de progression
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('user_id', testState.userId)
                    .single();
                    
                if (error) throw error;
                
                if (!data) {
                    throw new Error('Aucune donn√©e de progression trouv√©e');
                }
                
                // V√©rifier que les donn√©es sont correctes
                let parsedProgress;
                try {
                    parsedProgress = typeof data.progress_data === 'string' 
                        ? JSON.parse(data.progress_data) 
                        : data.progress_data;
                } catch (e) {
                    throw new Error(`Erreur lors du parsing des donn√©es: ${e.message}`);
                }
                
                const validPoints = parsedProgress.totalPoints === 100;
                const validModule = parsedProgress.completedModules?.mindfulness_1 === true;
                const validBadge = parsedProgress.badges?.some(b => b.id === 'mindfulness_beginner');
                
                if (!validPoints || !validModule) {
                    throw new Error('Les donn√©es de progression ne correspondent pas aux valeurs attendues');
                }
                
                log('Donn√©es de progression v√©rifi√©es avec succ√®s', 'success');
                showStepResult(6, true, 'Donn√©es de progression valides', {
                    id: data.id,
                    pointsMatch: validPoints,
                    moduleMatch: validModule,
                    badgeMatch: validBadge
                });
                
                testState.results.verifyProgress = {
                    success: true,
                    data: {
                        id: data.id,
                        validPoints,
                        validModule,
                        validBadge
                    }
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de la v√©rification de progression: ${error.message}`, 'error');
                showStepResult(6, false, `Erreur: ${error.message}`, error);
                
                testState.results.verifyProgress = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step7_saveModuleResponses() {
            try {
                log('√âtape 7: Enregistrement des r√©ponses de module');
                
                // V√©rifier si l'utilisateur est connect√©
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Aucun utilisateur connect√©');
                }
                
                // Cr√©er des r√©ponses de module
                const moduleId = 'mindfulness_1';
                const moduleResponses = {
                    q1: 'Tr√®s bien',
                    q2: 8,
                    q3: ['Option 1', 'Option 3'],
                    feedback: 'Module tr√®s utile',
                    completedAt: new Date().toISOString()
                };
                
                // Sauvegarder dans user_responses
                try {
                    const { error } = await supabase
                        .from('user_responses')
                        .upsert({
                            user_id: user.id,
                            module_id: moduleId,
                            responses: moduleResponses,
                            created_at: new Date()
                        });
                        
                    if (error) {
                        if (error.code === 'PGRST116' || error.message.includes("relation") || error.message.includes("does not exist")) {
                            log('Table user_responses non disponible, sauvegarde uniquement dans user_progress', 'warning');
                        } else {
                            throw error;
                        }
                    } else {
                        log('R√©ponses de module enregistr√©es avec succ√®s dans user_responses', 'success');
                    }
                } catch (err) {
                    log(`Erreur: ${err.message}`, 'warning');
                }
                
                // Mettre √† jour √©galement dans user_progress
                try {
                    // R√©cup√©rer les donn√©es actuelles
                    const { data: progressData, error: progressError } = await supabase
                        .from('user_progress')
                        .select('progress_data')
                        .eq('user_id', user.id)
                        .single();
                        
                    if (progressError) throw progressError;
                    
                    let updatedProgressData;
                    
                    if (progressData) {
                        // Mettre √† jour les donn√©es existantes
                        const parsedData = typeof progressData.progress_data === 'string' 
                            ? JSON.parse(progressData.progress_data) 
                            : progressData.progress_data;
                            
                        // Ajouter les r√©ponses du module
                        parsedData.moduleResponses = parsedData.moduleResponses || {};
                        parsedData.moduleResponses[moduleId] = {
                            responses: moduleResponses,
                            completedAt: new Date().toISOString()
                        };
                        
                        updatedProgressData = parsedData;
                    } else {
                        // Cr√©er de nouvelles donn√©es
                        updatedProgressData = {
                            userId: user.id,
                            totalPoints: 0,
                            streak: 0,
                            wellnessScore: 65,
                            completedModules: {},
                            completedChallenges: [],
                            badges: [],
                            moduleResponses: {
                                [moduleId]: {
                                    responses: moduleResponses,
                                    completedAt: new Date().toISOString()
                                }
                            },
                            islandProgress: {
                                mindfulness: { progress: 0, completedModules: 0 },
                                productivity: { progress: 0, completedModules: 0 },
                                stress: { progress: 0, completedModules: 0 },
                                balance: { progress: 0, completedModules: 0 }
                            }
                        };
                    }
                    
                    // Sauvegarder les donn√©es mises √† jour
                    const { error: saveError } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: user.id,
                            progress_data: JSON.stringify(updatedProgressData),
                            updated_at: new Date()
                        });
                        
                    if (saveError) throw saveError;
                    
                    log('R√©ponses de module mises √† jour dans user_progress', 'success');
                } catch (e) {
                    log(`Erreur lors de la mise √† jour dans user_progress: ${e.message}`, 'error');
                    throw e;
                }
                
                showStepResult(7, true, 'R√©ponses de module enregistr√©es avec succ√®s', {
                    moduleId,
                    responses: moduleResponses
                });
                
                testState.results.saveModuleResponses = {
                    success: true,
                    moduleId,
                    responses: moduleResponses
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de l'enregistrement des r√©ponses: ${error.message}`, 'error');
                showStepResult(7, false, `Erreur: ${error.message}`, error);
                
                testState.results.saveModuleResponses = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step8_verifyModuleResponses() {
            try {
                log('√âtape 8: V√©rification des r√©ponses de module');
                
                const moduleId = 'mindfulness_1';
                let moduleData = null;
                let moduleSource = "";
                
                // V√©rifier dans user_responses
                try {
                    const { data, error } = await supabase
                        .from('user_responses')
                        .select('*')
                        .eq('user_id', testState.userId)
                        .eq('module_id', moduleId);
                        
                    if (data && data.length > 0) {
                        moduleData = data[0];
                        moduleSource = "Table user_responses";
                        log('R√©ponses trouv√©es dans la table user_responses', 'success');
                    } else if (error && error.code !== 'PGRST116') {
                        log(`Erreur lors de la recherche dans user_responses: ${error.message}`, 'warning');
                    }
                } catch (err) {
                    log(`Exception lors de la recherche dans user_responses: ${err.message}`, 'warning');
                }
                
                // Si non trouv√©, v√©rifier dans progress_data
                if (!moduleData) {
                    try {
                        const { data, error } = await supabase
                            .from('user_progress')
                            .select('progress_data')
                            .eq('user_id', testState.userId)
                            .single();
                            
                        if (data?.progress_data) {
                            const parsedData = typeof data.progress_data === 'string' 
                                ? JSON.parse(data.progress_data) 
                                : data.progress_data;
                                
                            if (parsedData.moduleResponses?.[moduleId]) {
                                moduleData = { 
                                    embedded: true, 
                                    responses: parsedData.moduleResponses[moduleId] 
                                };
                                moduleSource = "Dans progress_data (user_progress)";
                                log('R√©ponses trouv√©es dans le champ progress_data de user_progress', 'success');
                            }
                        }
                    } catch (err) {
                        log(`Exception lors de la recherche dans progress_data: ${err.message}`, 'warning');
                    }
                }
                
                if (moduleData) {
                    showStepResult(8, true, `R√©ponses trouv√©es dans: ${moduleSource}`, moduleData);
                    
                    testState.results.verifyModuleResponses = {
                        success: true,
                        source: moduleSource,
                        data: moduleData
                    };
                    
                    return true;
                } else {
                    throw new Error('R√©ponses de module non trouv√©es');
                }
            } catch (error) {
                log(`Erreur lors de la v√©rification des r√©ponses: ${error.message}`, 'error');
                showStepResult(8, false, `Erreur: ${error.message}`, error);
                
                testState.results.verifyModuleResponses = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function step9_signout() {
            try {
                log('√âtape 9: D√©connexion');
                
                const { error } = await supabase.auth.signOut();
                
                if (error) throw error;
                
                log('D√©connexion r√©ussie', 'success');
                showStepResult(9, true, 'D√©connexion r√©ussie');
                
                testState.results.signout = {
                    success: true
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors de la d√©connexion: ${error.message}`, 'error');
                showStepResult(9, false, `Erreur: ${error.message}`, error);
                
                testState.results.signout = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        async function stepCleanup() {
            try {
                log('Nettoyage des donn√©es de test');
                
                if (!testState.userId) {
                    throw new Error('Aucun ID utilisateur √† nettoyer');
                }
                
                // Supprimer les donn√©es de test en parall√®le
                const tables = ['user_progress', 'onboarding_responses', 'user_responses', 'user_recommendations'];
                
                for (const table of tables) {
                    try {
                        const { error } = await supabase
                            .from(table)
                            .delete()
                            .eq('user_id', testState.userId);
                            
                        if (error && error.code !== 'PGRST116') {
                            log(`Avertissement: Impossible de nettoyer ${table}: ${error.message}`, 'warning');
                        } else {
                            log(`Table ${table} nettoy√©e`, 'success');
                        }
                    } catch (err) {
                        log(`Exception lors du nettoyage de ${table}: ${err.message}`, 'warning');
                    }
                }
                
                // Note: On ne peut pas supprimer l'utilisateur sans admin access
                // Mais on peut le signaler
                log('Utilisateur de test maintenu (suppression n√©cessite un acc√®s admin)', 'warning');
                
                showStepResult('Cleanup', true, 'Nettoyage des donn√©es effectu√©', {
                    userId: testState.userId,
                    tables: tables
                });
                
                testState.results.cleanup = {
                    success: true
                };
                
                return true;
            } catch (error) {
                log(`Erreur lors du nettoyage: ${error.message}`, 'error');
                showStepResult('Cleanup', false, `Erreur: ${error.message}`, error);
                
                testState.results.cleanup = {
                    success: false,
                    error: error.message
                };
                
                return false;
            }
        }
        
        // Fonction pour ex√©cuter le test complet
        async function runFullTest() {
            log('D√©marrage du test complet');
            document.getElementById('testResults').innerHTML = '<p>Test en cours...</p>';
            
            // R√©cup√©rer l'option de nettoyage
            testState.cleanup = document.getElementById('cleanupData').value === 'yes';
            
            // √âtape 1: Inscription
            await step1_signup();
            
            // √âtape 2: Connexion
            const signinSuccess = await step2_signin();
            if (!signinSuccess) {
                document.getElementById('testResults').innerHTML = `
                    <div class="error">
                        <h3>√âchec du test</h3>
                        <p>√âchec √† l'√©tape de connexion. Impossible de continuer.</p>
                    </div>
                `;
                return;
            }
            
            // √âtape 3: Enregistrement des donn√©es d'onboarding
            await step3_saveOnboarding();
            
            // √âtape 4: V√©rification des donn√©es d'onboarding
            await step4_verifyOnboarding();
            
            // √âtape 5: Cr√©ation de progression utilisateur
            await step5_createProgress();
            
            // √âtape 6: V√©rification des donn√©es de progression
            await step6_verifyProgress();
            
            // √âtape 7: Enregistrement de r√©ponses de module
            await step7_saveModuleResponses();
            
            // √âtape 8: V√©rification des r√©ponses de module
            await step8_verifyModuleResponses();
            
            // √âtape 9: D√©connexion
            await step9_signout();
            
            // Nettoyage si demand√©
            if (testState.cleanup) {
                await stepCleanup();
            }
            
            // Mise √† jour du r√©sum√© des tables
            await updateDatabaseSummary(testState.userId);
            
            // Afficher le r√©sum√© des tests
            const successCount = Object.values(testState.results).filter(r => r.success).length;
            const totalSteps = Object.keys(testState.results).length;
            
            document.getElementById('testResults').innerHTML = `
                <h3>R√©sum√© du test</h3>
                <p>${successCount} √©tapes sur ${totalSteps} r√©ussies</p>
                <ul>
                    ${Object.entries(testState.results).map(([step, result]) => `
                        <li>
                            ${result.success ? '‚úÖ' : '‚ùå'} 
                            <strong>${step}:</strong> 
                            ${result.success ? 'Succ√®s' : `√âchec - ${result.error}`}
                        </li>
                    `).join('')}
                </ul>
                <h3>Informations</h3>
                <p><strong>Email utilis√©:</strong> ${testState.email}</p>
                <p><strong>ID utilisateur:</strong> ${testState.userId}</p>
                <p><strong>Donn√©es nettoy√©es:</strong> ${testState.cleanup ? 'Oui' : 'Non'}</p>
            `;
            
            log('Test complet termin√©', 'success');
        }
        
        // Fonction pour ex√©cuter une √©tape sp√©cifique
        async function runStep(stepNumber) {
            const stepMap = {
                '1': step1_signup,
                '2': step2_signin,
                '3': step3_saveOnboarding,
                '4': step4_verifyOnboarding,
                '5': step5_createProgress,
                '6': step6_verifyProgress,
                '7': step7_saveModuleResponses,
                '8': step8_verifyModuleResponses,
                '9': step9_signout,
                'cleanup': stepCleanup
            };
            
            if (!stepMap[stepNumber]) {
                log(`√âtape ${stepNumber} non reconnue`, 'error');
                return;
            }
            
            // Marquer l'√©tape comme en cours
            const stepElement = document.getElementById(`step${stepNumber}`);
            stepElement.className = 'step step-pending';
            
            // Ex√©cuter l'√©tape
            await stepMap[stepNumber]();
            
            // Mise √† jour du r√©sum√© des tables si l'utilisateur est d√©fini
            if (testState.userId) {
                await updateDatabaseSummary(testState.userId);
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // G√©n√©rer un email de test
            const testEmail = `test_${Date.now()}@example.com`;
            document.getElementById('testEmail').value = testEmail;
            
            // Bouton pour lancer le test complet
            document.getElementById('startTestButton').addEventListener('click', runFullTest);
            
            // Bouton pour le mode pas √† pas
            document.getElementById('stepByStepButton').addEventListener('click', function() {
                const container = document.getElementById('stepByStepContainer');
                container.classList.toggle('hidden');
                this.textContent = container.classList.contains('hidden') ? 'Mode pas √† pas' : 'Masquer mode pas √† pas';
            });
            
            // Attacher les gestionnaires d'√©v√©nements pour les √©tapes individuelles
            document.querySelectorAll('[data-step]').forEach(button => {
                button.addEventListener('click', function() {
                    runStep(this.getAttribute('data-step'));
                });
            });
            
            // Configurer les toggles de section
            document.getElementById('logToggle').addEventListener('click', function() {
                const section = document.getElementById('logSection');
                section.classList.toggle('hidden');
                this.querySelector('span').textContent = section.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
            });
            
            document.getElementById('resultsToggle').addEventListener('click', function() {
                const section = document.getElementById('resultsSection');
                section.classList.toggle('hidden');
                this.querySelector('span').textContent = section.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
            });
        });
    </script>
</body>
</html>